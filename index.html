<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé£ –ü–æ–π–º–∞–π —Ä—ã–±–∫—É!</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            height: 100vh;
        }
        #gameContainer { position: relative; width: 100%; height: 100%; }
        #gameCanvas { display: block; width: 100%; height: 100%; }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            gap: 8px;
            z-index: 1000;
        }
        .score-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .screen.active { display: flex; }
        h1 { 
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff; 
            font-size: 36px; 
            margin-bottom: 30px; 
            text-align: center; 
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.8), 0 0 40px rgba(0, 212, 255, 0.4);
            letter-spacing: 2px;
        }
        .mode-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 400px;
        }
        .mode-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .mode-card:hover::before {
            left: 100%;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            border-color: rgba(0, 212, 255, 0.5);
        }
        .mode-card.free {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05));
            border-color: rgba(76, 175, 80, 0.3);
        }
        .mode-card.challenge {
            background: linear-gradient(135deg, rgba(255, 99, 71, 0.2), rgba(255, 99, 71, 0.05));
            border-color: rgba(255, 99, 71, 0.3);
        }
        .mode-card.bet {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05));
            border-color: rgba(255, 215, 0, 0.3);
        }
        .mode-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }
        .mode-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }
        .balance-display {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #FFD700;
            font-weight: bold;
        }
        .buy-btn {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            transition: all 0.3s;
        }
        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
        }
        #resultStats { color: white; font-size: 18px; margin: 15px 0; text-align: center; line-height: 1.8; }
        .success { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div class="score-box">üíé <span id="scoreVal">0</span></div>
            <div class="score-box" id="starsBalance">üíé <span id="telegramStarsVal">0</span></div>
            <div class="score-box" id="timerUI" style="display:none;">‚è±Ô∏è <span id="timeVal">02:00</span></div>
            <div class="score-box" id="targetUI" style="display:none;">üéØ <span id="caughtVal">0</span>/25</div>
        </div>
        
        <div id="startScreen" class="screen active">
            <h1>üé£ FISHING</h1>
            <button class="buy-btn" onclick="showModes()">‚ñ∂ –ù–ê–ß–ê–¢–¨</button>
        </div>
        
        <div id="modeScreen" class="screen">
            <h1>–í–´–ë–ï–†–ò –†–ï–ñ–ò–ú</h1>
            
            <div class="balance-display">
                <span>üíé</span>
                <span>–ë–∞–ª–∞–Ω—Å: <span id="menuStars">0</span> –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</span>
            </div>
            
            <div class="mode-grid">
                <div class="mode-card free" onclick="startGame('free')">
                    <div class="mode-title">üé£ –°–í–û–ë–û–î–ù–ê–Ø</div>
                    <div class="mode-desc">–ò–≥—Ä–∞–π –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</div>
                </div>
                
                <div class="mode-card challenge" onclick="startGame('challenge')">
                    <div class="mode-title">üèÜ –ò–°–ü–´–¢–ê–ù–ò–ï</div>
                    <div class="mode-desc">25 —Ä—ã–±–æ–∫ –∑–∞ 2 –º–∏–Ω—É—Ç—ã!</div>
                </div>
                
                <div class="mode-card bet" onclick="requestBet()">
                    <div class="mode-title">üíé –°–¢–ê–í–ö–ê 1</div>
                    <div class="mode-desc">–í—ã–∏–≥—Ä—ã—à: 2 –ö—Ä–∏—Å—Ç–∞–ª–ª–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–æ—Ç–µ</div>
                </div>
            </div>
            
            <button class="buy-btn" onclick="requestBuyStars()">üíé –ö–£–ü–ò–¢–¨ –ö–†–ò–°–¢–ê–õ–õ–´</button>
        </div>
        
        <div id="gameOverScreen" class="screen">
            <h1 id="resultTitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h1>
            <div id="resultStats"></div>
            <button class="buy-btn" onclick="showModes()">‚Üª –ï–©–Å –†–ê–ó</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏ Stars -->
        <div id="buyModal" class="screen" style="background: rgba(0,0,0,0.9);">
            <h1 style="color: #FFD700; margin-bottom: 30px;">üíé –ö–£–ü–ò–¢–¨ –ö–†–ò–°–¢–ê–õ–õ–´</h1>
            <div style="display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 350px;">
                <div class="mode-card" onclick="buyStarsNow(10, 1)" style="cursor: pointer; padding: 20px;">
                    <div style="font-size: 24px; font-weight: bold; color: #FFD700;">10 üíé</div>
                    <div style="color: white; margin-top: 5px;">1 Telegram Star</div>
                </div>
                <div class="mode-card" onclick="buyStarsNow(50, 5)" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, rgba(156, 39, 176, 0.3), rgba(156, 39, 176, 0.1));">
                    <div style="font-size: 24px; font-weight: bold; color: #FFD700;">50 üíé</div>
                    <div style="color: white; margin-top: 5px;">5 Telegram Stars <span style="color: #4CAF50;">(-10%)</span></div>
                </div>
                <div class="mode-card" onclick="buyStarsNow(100, 9)" style="cursor: pointer; padding: 20px; background: linear-gradient(135deg, rgba(255, 152, 0, 0.3), rgba(255, 152, 0, 0.1));">
                    <div style="font-size: 24px; font-weight: bold; color: #FFD700;">100 üíé</div>
                    <div style="color: white; margin-top: 5px;">9 Telegram Stars <span style="color: #4CAF50;">(-10%)</span></div>
                </div>
            </div>
            <button class="buy-btn" onclick="closeBuyModal()" style="margin-top: 30px; background: #666;">‚úï –û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameState = 'MENU', gameMode = 'free', score = 0, caught = 0, timeLeft = 120;
        let timerId = null, animationId = null;
        let crystals = parseInt(localStorage.getItem('crystals')) || 0; // –ö—Ä–∏—Å—Ç–∞–ª–ª—ã - –∏–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
        let boat = { x: 0, y: 120, dir: 1, angle: 0 };
        let hook = { x: 0, y: 0, len: 0, drop: false, retract: false, fish: null };
        let fishes = [], bubbles = [], clouds = [], seaweed = [], waves = [];
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            boat.y = canvas.height * 0.12;
            clouds = []; for (let i = 0; i < 4; i++) clouds.push({ x: Math.random() * canvas.width, y: 30 + Math.random() * 50, s: 25 + Math.random() * 20, sp: 0.3 + Math.random() * 0.3 });
            seaweed = []; for (let i = 0; i < 15; i++) seaweed.push({ x: Math.random() * canvas.width, h: 50 + Math.random() * 80, w: Math.random() * Math.PI * 2 });
            waves = []; for (let i = 0; i < 3; i++) waves.push({ a: 5 + Math.random() * 5, f: 0.01 + Math.random() * 0.005, s: Math.random() * Math.PI * 2, sp: 0.03 });
        }
        window.addEventListener('resize', resize);
        resize();
        
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); if (id) document.getElementById(id).classList.add('active'); }
        function showModes() { document.getElementById('menuStars').textContent = crystals; showScreen('modeScreen'); }
        function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0'); }
        function updateUI() { document.getElementById('scoreVal').textContent = score; document.getElementById('telegramStarsVal').textContent = crystals; document.getElementById('timeVal').textContent = formatTime(timeLeft); document.getElementById('caughtVal').textContent = caught; }
        
        function requestBet() {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify({action: 'request_bet', amount: 1}));
                alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ —Å—Ç–∞–≤–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç!');
            }
        }
        
        function requestBuyStars() {
            showScreen('buyModal');
        }
        
        function closeBuyModal() {
            showScreen('modeScreen');
        }
        
        function buyStarsNow(amount, price) {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify({
                    action: 'buy_crystals_inline',
                    amount: amount,
                    price: price
                }));
                alert(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É ${amount} –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
                closeBuyModal();
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∞ - –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º
                crystals += amount;
                localStorage.setItem('crystals', crystals);
                updateUI();
                document.getElementById('menuStars').textContent = crystals;
                alert(`‚úÖ –¢–µ—Å—Ç: –¥–æ–±–∞–≤–ª–µ–Ω–æ ${amount} –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!`);
                closeBuyModal();
            }
        }
        
        function startGame(mode) {
            gameMode = mode; gameState = 'PLAYING'; score = 0; caught = 0; timeLeft = 120; fishes = []; bubbles = [];
            hook = { x: 0, y: 0, len: 0, drop: false, retract: false, fish: null };
            boat.x = canvas.width / 2;
            document.getElementById('timerUI').style.display = mode === 'challenge' ? 'block' : 'none';
            document.getElementById('targetUI').style.display = mode === 'challenge' ? 'block' : 'none';
            updateUI(); showScreen(null);
            if (mode === 'challenge') startTimer();
            if (animationId) cancelAnimationFrame(animationId);
            gameLoop();
        }
        
        function startTimer() { if (timerId) clearInterval(timerId); timerId = setInterval(() => { if (gameState !== 'PLAYING') { clearInterval(timerId); timerId = null; return; } timeLeft--; updateUI(); if (timeLeft <= 0) endGame(); }, 1000); }
        
        function endGame() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            if (timerId) { clearInterval(timerId); timerId = null; }
            const won = caught >= 25;
            document.getElementById('resultTitle').textContent = gameMode === 'challenge' ? (won ? 'üéâ –ü–û–ë–ï–î–ê!' : '‚è∞ –í–†–ï–ú–Ø –í–´–®–õ–û!') : 'üé£ –û–¢–õ–ò–ß–ù–´–ô –£–õ–û–í!';
            document.getElementById('resultStats').innerHTML = `üéØ –ü–æ–π–º–∞–Ω–æ: <b>${caught}</b>${gameMode === 'challenge' ? '/25' : ''}<br>üíé –û—á–∫–∏: <b>${score}</b>`;
            showScreen('gameOverScreen');
            if (window.Telegram?.WebApp) window.Telegram.WebApp.sendData(JSON.stringify({action: 'game_result', mode: gameMode, score: score, caught: caught, success: won}));
        }
        
        function dropHook() {
            if (gameState !== 'PLAYING' || hook.drop || hook.retract) return;
            hook.drop = true; hook.x = boat.x; hook.y = boat.y + 20; hook.len = 0;
        }
        
        function gameLoop() {
            if (gameState !== 'PLAYING') return;
            boat.x += 3 * boat.dir;
            if (boat.x < 50) { boat.x = 50; boat.dir = 1; }
            if (boat.x > canvas.width - 50) { boat.x = canvas.width - 50; boat.dir = -1; }
            boat.angle = Math.sin(Date.now() / 1000) * 0.05;
            
            for (const c of clouds) { c.x += c.sp; if (c.x > canvas.width + 50) c.x = -50; }
            for (const w of waves) { w.s += w.sp; }
            for (const s of seaweed) { s.w += 0.02; }
            
            if (Math.random() < 0.03) bubbles.push({ x: Math.random() * canvas.width, y: canvas.height, s: 2 + Math.random() * 5, sp: 1 + Math.random() });
            for (const b of bubbles) b.y -= b.sp;
            bubbles = bubbles.filter(b => b.y > -10);
            
            if (hook.drop) {
                hook.len += 10;
                const targetX = boat.x + Math.sin(boat.angle) * 15;
                hook.x += (targetX - hook.x) * 0.1;
                const maxLen = canvas.height - boat.y - 80;
                if (hook.len >= maxLen) { hook.drop = false; hook.retract = true; }
                for (let i = fishes.length - 1; i >= 0; i--) {
                    const f = fishes[i];
                    if (f.caught) continue;
                    const dx = hook.x - f.x, dy = (hook.y + 20 + hook.len) - f.y;
                    if (dx*dx + dy*dy < 1600) {
                        f.caught = true; hook.fish = f; hook.drop = false; hook.retract = true;
                        score += f.type.p; caught++; updateUI();
                        if (gameMode === 'challenge' && caught >= 25) { endGame(); return; }
                        break;
                    }
                }
            }
            
            if (hook.retract) {
                hook.len -= 14;
                const targetX = boat.x + Math.sin(boat.angle) * 15;
                hook.x += (targetX - hook.x) * 0.15;
                hook.y = boat.y + 20 + hook.len;
                if (hook.fish) { hook.fish.x = hook.x; hook.fish.y = hook.y; }
                if (hook.len <= 0) { hook.retract = false; hook.len = 0; if (hook.fish) { fishes = fishes.filter(f => f !== hook.fish); hook.fish = null; } }
            }
            
            for (const f of fishes) if (!f.caught) { f.x += f.type.s * f.dir; f.w += 0.15; }
            fishes = fishes.filter(f => f.x > -100 && f.x < canvas.width + 100);
            
            if (fishes.length < 5 && Math.random() < 0.02) {
                const types = [
                    {e: 'üêü', s: 2, p: 10}, {e: 'üê†', s: 3, p: 15}, {e: 'üê°', s: 1.5, p: 20},
                    {e: 'ü¶à', s: 4, p: 25}, {e: 'üêô', s: 2.5, p: 30}, {e: 'ü¶ë', s: 3.5, p: 35}
                ];
                const t = types[Math.floor(Math.random() * types.length)];
                const dir = Math.random() > 0.5 ? 1 : -1;
                fishes.push({ x: dir > 0 ? -50 : canvas.width + 50, y: boat.y + 70 + Math.random() * (canvas.height - boat.y - 200), type: t, dir: dir, w: Math.random() * Math.PI * 2, caught: false });
            }
            
            ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (const c of clouds) { ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.arc(c.x, c.y, c.s, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x + c.s * 0.6, c.y + c.s * 0.2, c.s * 0.8, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x - c.s * 0.6, c.y + c.s * 0.2, c.s * 0.8, 0, Math.PI * 2); ctx.fill(); }
            ctx.fillStyle = 'rgba(0,100,200,0.3)'; for (const w of waves) { ctx.beginPath(); for (let x = 0; x < canvas.width; x += 10) { ctx.lineTo(x, canvas.height * 0.25 + Math.sin(x * w.f + w.s) * w.a); } ctx.lineTo(canvas.width, canvas.height); ctx.lineTo(0, canvas.height); ctx.fill(); }
            ctx.fillStyle = '#228B22'; for (const s of seaweed) { ctx.beginPath(); for (let y = canvas.height, i = 0; y > canvas.height - s.h; y -= 10, i++) { ctx.lineTo(s.x + Math.sin(s.w + i * 0.3) * 15, y); } ctx.lineWidth = 8; ctx.strokeStyle = '#228B22'; ctx.stroke(); }
            for (const b of bubbles) { ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(b.x + Math.sin(b.y * 0.02) * 10, b.y, b.s, 0, Math.PI * 2); ctx.fill(); }
            ctx.save(); ctx.translate(boat.x, boat.y); ctx.rotate(boat.angle);
            const boatGrad = ctx.createLinearGradient(-35, -15, 35, 15); boatGrad.addColorStop(0, '#8B4513'); boatGrad.addColorStop(0.5, '#A0522D'); boatGrad.addColorStop(1, '#5D3A1A'); ctx.fillStyle = boatGrad; ctx.beginPath(); ctx.moveTo(-35, 10); ctx.lineTo(35, 10); ctx.lineTo(25, 35); ctx.lineTo(-25, 35); ctx.closePath(); ctx.fill(); ctx.strokeStyle = '#4A3728'; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle = '#4A3728'; ctx.fillRect(-30, 15, 60, 10);
            ctx.fillStyle = '#F5F5DC'; ctx.fillRect(-3, -30, 6, 45); ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(20, -15); ctx.lineTo(0, 0); ctx.closePath(); ctx.fill();
            ctx.restore();
            if (hook.len > 0 || hook.fish) { ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(boat.x + Math.sin(boat.angle) * 15, boat.y + 20); ctx.quadraticCurveTo(boat.x + Math.sin(boat.angle) * 15 + (hook.x - boat.x - Math.sin(boat.angle) * 15) * 0.3, boat.y + 20 + hook.len * 0.5, hook.x, hook.y + 20 + hook.len); ctx.stroke(); ctx.fillStyle = '#888'; ctx.beginPath(); ctx.arc(hook.x, hook.y + 20 + hook.len, 4, 0, Math.PI * 2); ctx.fill(); }
            for (const f of fishes) { ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(Math.sin(f.w) * 0.1); ctx.font = '30px Arial'; ctx.fillText(f.type.e, -15, 10); ctx.restore(); }
            if (hook.fish) { ctx.save(); ctx.translate(hook.fish.x, hook.fish.y); ctx.font = '25px Arial'; ctx.fillText(hook.fish.type.e, -12, 8); ctx.restore(); }
            animationId = requestAnimationFrame(gameLoop);
        }
        
        canvas.addEventListener('mousedown', dropHook);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); dropHook(); });
        document.addEventListener('keydown', (e) => { if (e.code === 'Space') dropHook(); });
        
        updateUI();
        showScreen('startScreen');
    </script>
</body>
</html>